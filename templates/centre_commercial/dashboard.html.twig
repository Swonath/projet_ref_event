{% extends 'centre_commercial/base_dashboard.html.twig' %}

{% block title %}Tableau de bord - Centre Commercial{% endblock %}

{% block dashboard_content %}

<div class="page-header">
    <h1 class="page-title">Bonjour {{ centre.nomCentre }} ğŸ‘‹</h1>
    <p class="page-subtitle">Voici un aperÃ§u de votre activitÃ©</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">â³</div>
        <div class="stat-value">{{ stats.reservations_en_attente }}</div>
        <div class="stat-label">Ã€ valider</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-value">{{ stats.ca_mois|number_format(0, ',', ' ') }}â‚¬</div>
        <div class="stat-label">CA ce mois</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">ğŸª</div>
        <div class="stat-value">{{ stats.emplacements_actifs }}</div>
        <div class="stat-label">Emplacements actifs</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">â­</div>
        <div class="stat-value">{{ stats.moyenne_avis|number_format(1) }}</div>
        <div class="stat-label">Note moyenne</div>
    </div>
</div>

<!-- RÃ©servations Ã  traiter -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">RÃ©servations Ã  traiter</h2>
        <a href="{{ path('centre_reservations_index', {filtre: 'en_attente'}) }}" class="btn-link">Voir tout â†’</a>
    </div>

    {% if reservations_en_attente is empty %}
        <div class="empty-state">
            <div class="empty-icon">âœ…</div>
            <div class="empty-title">Aucune rÃ©servation en attente</div>
            <div class="empty-text">Toutes les demandes ont Ã©tÃ© traitÃ©es</div>
        </div>
    {% else %}
        {% for reservation in reservations_en_attente %}
        <div class="reservation-card">
            <div class="reservation-image">
                {% if reservation.emplacement.photos|length > 0 %}
                    <img src="{{ asset('uploads/photos/' ~ reservation.emplacement.photos[0].cheminFichier) }}"
                         alt="{{ reservation.emplacement.titreAnnonce }}">
                {% else %}
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f5f5f5; color:#999;">
                        ğŸ“·
                    </div>
                {% endif %}
            </div>

            <div class="reservation-info">
                <h3>{{ reservation.emplacement.titreAnnonce }}</h3>
                <div class="reservation-details">
                    <strong>Locataire:</strong> {{ reservation.locataire.nom }}
                </div>
                <div class="reservation-details">
                    <strong>TÃ©lÃ©phone:</strong> {{ reservation.locataire.telephone }}
                </div>
                <div class="reservation-details">
                    Du {{ reservation.dateDebut|date('d/m/Y') }} au {{ reservation.dateFin|date('d/m/Y') }}
                </div>
                <span class="reservation-status status-{{ reservation.statut.cssClass }}">
                    {{ reservation.statut.icone }} {{ reservation.statut.libelle }}
                </span>
            </div>

            <div class="reservation-actions">
                <div class="reservation-price">{{ reservation.montantTotal }} â‚¬</div>
                <form method="POST" action="{{ path('centre_reservations_valider', {id: reservation.id}) }}" style="display:inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('valider_' ~ reservation.id) }}">
                    <button type="submit" class="btn-small btn-primary-small" onclick="return confirm('Valider cette rÃ©servation ?')">
                        âœ… Valider
                    </button>
                </form>
                <a href="{{ path('centre_reservations_detail', {id: reservation.id}) }}" class="btn-small btn-secondary-small">
                    Voir dÃ©tail
                </a>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Messages rÃ©cents -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Messages rÃ©cents</h2>
        <a href="{{ path('centre_messages_index') }}" class="btn-link">Voir tout â†’</a>
    </div>

    {% if messages is empty %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <div class="empty-title">Aucun nouveau message</div>
            <div class="empty-text">Vous n'avez pas de message non lu</div>
        </div>
    {% else %}
        <div class="messages-list">
            {% for item in messages %}
                {% set conversation = item.conversation %}
                <div class="message-item">
                    <div class="message-avatar">
                        {% if conversation.locataire.photoProfile %}
                            <img src="{{ asset('uploads/profiles/' ~ conversation.locataire.photoProfile) }}" alt="Avatar">
                        {% else %}
                            {{ conversation.locataire.nom|slice(0, 2)|upper }}
                        {% endif %}
                    </div>
                    <div class="message-info">
                        <div class="message-header">
                            <strong>{{ conversation.locataire.nom }}</strong>
                            <span class="message-badge">{{ item.nbNonLus }}</span>
                        </div>
                        <div class="message-subject">{{ conversation.sujet }}</div>
                        <div class="message-date">{{ conversation.dernierMessageDate|date('d/m/Y H:i') }}</div>
                    </div>
                    <div class="message-action">
                        <a href="{{ path('centre_messages_show', {id: conversation.id}) }}" class="btn-small btn-primary-small">
                            RÃ©pondre
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

{% endblock %}
