{% extends 'locataire/base_dashboard.html.twig' %}

{% block title %}Mes favoris - R√©f√©rences √âv√©nements{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/favoris.js') }}"></script>
{% endblock %}

{% block dashboard_content %}

<div class="section">
<div class="page-header">
    <h1 class="page-title">Mes favoris ‚ù§Ô∏è</h1>
    <p class="page-subtitle">{{ favoris|length }} emplacement{% if favoris|length > 1 %}s{% endif %} en favori</p>
</div>

{% if favoris is empty %}
    <div class="empty-state">
        <div class="empty-icon">‚ù§Ô∏è</div>
        <div class="empty-title">Aucun favori</div>
        <div class="empty-text">
            Vous n'avez pas encore d'emplacement en favori.<br>
            Ajoutez-en en cliquant sur le c≈ìur ‚ù§Ô∏è sur les annonces.
        </div>
        <a href="{{ path('app_home_page') }}" class="btn-primary">
            Rechercher un emplacement
        </a>
    </div>
{% else %}
    {% for favori in favoris %}
        {% set emplacement = favori.emplacement %}
        <div class="reservation-card" data-favori-id="{{ favori.id }}">
            <div class="reservation-image">
                {% if emplacement.photos|length > 0 %}
                    <img src="{{ asset('uploads/photos/' ~ emplacement.photos[0].cheminFichier) }}" alt="{{ emplacement.titreAnnonce }}">
                {% else %}
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f5f5f5; color:#999;">
                        üì∑
                    </div>
                {% endif %}
            </div>
            
            <div class="reservation-info">
                <h3>{{ emplacement.titreAnnonce }}</h3>
                <div class="reservation-details">
                    üìç {{ emplacement.centreCommercial.nomCentre }} ‚Ä¢ 
                    {{ emplacement.typeEmplacement }} ‚Ä¢ 
                    {{ emplacement.surface }} m¬≤
                </div>
                <div class="reservation-details">
                    ‚ù§Ô∏è Ajout√© le {{ favori.dateAjout|date('d/m/Y') }}
                </div>
                <span class="reservation-status status-disponible">
                    ‚úì Disponible
                </span>
            </div>
            
            <div class="reservation-actions">
                <div class="reservation-price">{{ emplacement.tarifJour }}‚Ç¨/jour</div>
                <a href="{{ path('app_home_page') }}" 
                   class="btn-small btn-primary-small">Voir d√©tails</a>
                <button class="btn-small btn-secondary-small" 
                        onclick="retirerDesFavoris({{ emplacement.id }}, this)"
                        title="Retirer des favoris">
                    Retirer ‚ù§Ô∏è
                </button>
            </div>
        </div>
    {% endfor %}
{% endif %}

{# Bouton Afficher Plus #}
{% if totalFavoris > 12 %}
<div id="load-more-container" style="text-align: center; margin-top: 30px;">
    <button id="btn-load-more" class="btn-primary" onclick="chargerPlusFavoris()">
        Afficher plus (<span id="favoris-affiches">12</span>/{{ totalFavoris }})
    </button>
</div>
{% endif %}
</div>

<script>
let offsetFavoris = 12; // Commence apr√®s les 12 premiers
const totalFavoris = {{ totalFavoris }};

function chargerPlusFavoris() {
    const btn = document.getElementById('btn-load-more');
    const originalText = btn.innerHTML;
    
    // D√©sactiver le bouton pendant le chargement
    btn.disabled = true;
    btn.innerHTML = 'Chargement...';
    
    fetch(`{{ path('locataire_favoris_charger_plus') }}?offset=${offsetFavoris}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.html) {
                // Trouver le dernier √©l√©ment .reservation-card
                const lastCard = document.querySelector('.reservation-card:last-of-type');
                
                // Ins√©rer le nouveau HTML apr√®s le dernier √©l√©ment
                lastCard.insertAdjacentHTML('afterend', data.html);
                
                // Mettre √† jour l'offset
                offsetFavoris += 12;
                
                // Mettre √† jour le compteur
                const affichesSpan = document.getElementById('favoris-affiches');
                const nouveauNombre = Math.min(offsetFavoris, totalFavoris);
                affichesSpan.textContent = nouveauNombre;
                
                // Si tous les favoris sont charg√©s, masquer le bouton
                if (!data.hasMore || offsetFavoris >= totalFavoris) {
                    document.getElementById('load-more-container').style.display = 'none';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('Erreur lors du chargement');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert('Erreur lors du chargement des favoris');
        });
}

function retirerDesFavoris(emplacementId, button) {
    if (!confirm('Voulez-vous vraiment retirer cet emplacement de vos favoris ?')) {
        return;
    }
    
    // Trouver la card parente
    const card = button.closest('.reservation-card');
    
    // Animation de suppression
    card.style.opacity = '0.5';
    button.disabled = true;
    button.textContent = 'Suppression...';
    
    // Simuler une suppression (√† remplacer par un vrai appel AJAX)
    fetch(`/dashboard/locataire/favoris/retirer/${emplacementId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Supprimer la card avec animation
            card.style.transition = 'all 0.3s ease';
            card.style.transform = 'translateX(-100%)';
            card.style.opacity = '0';
            
            setTimeout(() => {
                card.remove();
                
                // Si plus aucun favori, recharger la page pour afficher l'√©tat vide
                if (document.querySelectorAll('.reservation-card').length === 0) {
                    location.reload();
                }
            }, 300);
        } else {
            alert(data.message || 'Erreur lors de la suppression');
            card.style.opacity = '1';
            button.disabled = false;
            button.textContent = 'Retirer ‚ù§Ô∏è';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression du favori');
        card.style.opacity = '1';
        button.disabled = false;
        button.textContent = 'Retirer ‚ù§Ô∏è';
    });
}
</script>

{% endblock %}
