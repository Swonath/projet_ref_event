{% extends 'locataire/base_dashboard.html.twig' %}

{% block title %}Conversation - {{ conversation.centreCommercial.nomCentre }}{% endblock %}

{% block dashboard_content %}

<!-- Flash messages -->
{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('error') %}
    <div class="alert alert-error">{{ message }}</div>
{% endfor %}

<!-- En-t√™te de la conversation -->
<div class="conversation-header-page">
    <a href="{{ conversation.estArchivee ? path('locataire_messages_archives') : path('locataire_messages_index') }}" class="back-link">
        ‚Üê Retour aux {{ conversation.estArchivee ? 'archives' : 'messages' }}
    </a>

    <div class="conversation-title-section">
        <div class="conversation-avatar-large">
            {{ conversation.centreCommercial.nomCentre|slice(0, 2)|upper }}
        </div>
        <div>
            <h1 class="page-title">
                {% if conversation.estArchivee %}
                    <span style="background: #6b6b6b; color: white; padding: 4px 12px; border-radius: 6px; font-size: 14px; margin-right: 12px;">ARCHIV√â</span>
                {% endif %}
                {{ conversation.centreCommercial.nomCentre }}
            </h1>
            <p class="page-subtitle">
                {% if conversation.sujet %}
                    {{ conversation.sujet }}
                {% elseif conversation.reservation %}
                    R√©servation : {{ conversation.reservation.emplacement.titreAnnonce }}
                {% else %}
                    Conversation
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Actions -->
    <div class="conversation-actions">
        {% if conversation.reservation %}
            <a href="{{ path('locataire_reservation_detail', {id: conversation.reservation.id}) }}"
               class="btn-small btn-secondary-small">
                üìã Voir la r√©servation
            </a>
        {% endif %}

        {% if conversation.estArchivee %}
            <form method="post" action="{{ path('locataire_messages_unarchive', {id: conversation.id}) }}"
                  style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('unarchive_conversation_' ~ conversation.id) }}">
                <button type="submit" class="btn-small btn-secondary-small">
                    ‚Ü©Ô∏è Restaurer
                </button>
            </form>
        {% else %}
            <form method="post" action="{{ path('locataire_messages_archive', {id: conversation.id}) }}"
                  onsubmit="return confirm('√ätes-vous s√ªr de vouloir archiver cette conversation ?');"
                  style="display: inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('archive_conversation_' ~ conversation.id) }}">
                <button type="submit" class="btn-small btn-secondary-small">
                    üìÅ Archiver
                </button>
            </form>
        {% endif %}
    </div>
</div>

<!-- Zone des messages -->
<div class="messages-container" id="messagesContainer">
    <div class="messages-list">
        {% if messages is empty %}
            <div class="empty-state">
                <div class="empty-icon">üí¨</div>
                <div class="empty-title">Aucun message</div>
                <div class="empty-text">Commencez la conversation en envoyant un message ci-dessous</div>
            </div>
        {% else %}
            {% for message in messages %}
                <div class="message-item message-{{ message.typeExpediteur }}">
                    <!-- Avatar -->
                    <div class="message-avatar">
                        {% if message.typeExpediteur == 'locataire' %}
                            {% if app.user.photoProfile %}
                                <img src="{{ asset('uploads/profiles/' ~ app.user.photoProfile) }}" alt="Vous" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                {{ app.user.nom|slice(0, 2)|upper }}
                            {% endif %}
                        {% else %}
                            {{ conversation.centreCommercial.nomCentre|slice(0, 2)|upper }}
                        {% endif %}
                    </div>

                    <div class="message-bubble">
                        <div class="message-header">
                            <span class="message-author">
                                {% if message.typeExpediteur == 'locataire' %}
                                    Vous
                                {% else %}
                                    {{ conversation.centreCommercial.nomCentre }}
                                {% endif %}
                            </span>
                            <span class="message-time">
                                {{ message.dateEnvoi|date('d/m/Y √† H:i') }}
                            </span>
                        </div>
                        <div class="message-content">
                            {{ message.contenu|nl2br }}
                        </div>
                        {% if message.estLu and message.typeExpediteur == 'locataire' %}
                            <div class="message-read-status">
                                ‚úì‚úì Lu {{ message.dateLecture ? 'le ' ~ message.dateLecture|date('d/m √† H:i') : '' }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Formulaire d'envoi de message -->
<div class="message-compose-container">
    <form method="post" action="{{ path('locataire_messages_send', {id: conversation.id}) }}"
          class="message-compose-form">
        <input type="hidden" name="_token" value="{{ csrf_token('send_message_' ~ conversation.id) }}">

        <div class="message-compose">
            <textarea
                name="contenu"
                class="message-input"
                placeholder="√âcrivez votre message ici..."
                rows="3"
                required></textarea>

            <button type="submit" class="btn-primary btn-send-message">
                Envoyer üì§
            </button>
        </div>
    </form>
</div>

<script>
// Scroll automatique vers le bas des messages
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
});
</script>

{% endblock %}
