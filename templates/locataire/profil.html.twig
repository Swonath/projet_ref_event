{% extends 'locataire/base_dashboard.html.twig' %}

{% block title %}Mon profil - R√©f√©rences √âv√©nements{% endblock %}

{% block dashboard_content %}

<div class="page-header">
    <h1 class="page-title">Mon profil</h1>
    <p class="page-subtitle">G√©rez vos informations personnelles</p>
</div>

<!-- Flash messages -->
{% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
{% endfor %}
{% for message in app.flashes('error') %}
    <div class="alert alert-error">{{ message }}</div>
{% endfor %}

<form method="post" action="{{ path('locataire_profil_edit') }}" enctype="multipart/form-data">

    <!-- Photo de profil -->
    <div class="section">
        <h2 class="section-title">Photo de profil</h2>

        <div class="profile-photo-section">
            <div class="profile-photo-preview">
                {% if app.user.photoProfile %}
                    <img src="{{ asset('uploads/profiles/' ~ app.user.photoProfile) }}"
                         alt="Photo de profil"
                         class="profile-photo-img"
                         id="photoPreview">
                    <div class="profile-photo-placeholder" id="photoPlaceholder" style="display: none;">
                        {{ app.user.nom|slice(0, 2)|upper }}
                    </div>
                {% else %}
                    <div class="profile-photo-placeholder" id="photoPlaceholder">
                        {{ app.user.nom|slice(0, 2)|upper }}
                    </div>
                    <img src="" alt="Aper√ßu" class="profile-photo-img" id="photoPreview" style="display: none;">
                {% endif %}
            </div>

            <div class="profile-photo-actions">
                <label for="photo_profile" class="btn-secondary btn-upload">
                    üì∑ {% if app.user.photoProfile %}Changer la photo{% else %}Ajouter une photo{% endif %}
                </label>
                <input type="file"
                       id="photo_profile"
                       name="photo_profile"
                       accept="image/jpeg,image/png,image/gif,image/webp"
                       style="display: none;"
                       onchange="previewPhoto(this)">

                {% if app.user.photoProfile %}
                    <button type="button" class="btn-secondary btn-delete-photo" onclick="confirmDeletePhoto()">
                        üóëÔ∏è Supprimer
                    </button>
                {% endif %}

                <p class="photo-hint">JPG, PNG, GIF ou WebP. Max 5 Mo.</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Informations personnelles</h2>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label required">Nom</label>
                <input type="text" name="nom" class="form-control" value="{{ app.user.nom }}" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label required">Email</label>
                <input type="email" name="email" class="form-control" value="{{ app.user.email }}" required>
                <small class="form-text">Cet email est utilis√© pour vous connecter</small>
            </div>

            <div class="form-group">
                <label class="form-label required">T√©l√©phone</label>
                <input type="tel" name="telephone" class="form-control" value="{{ app.user.telephone }}" required>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Adresse</label>
            <input type="text" name="adresse" class="form-control" value="{{ app.user.adresseFacturation ?? '' }}" placeholder="Num√©ro et nom de rue">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Code postal</label>
                <input type="text" name="codePostal" class="form-control" value="{{ app.user.codePostal ?? '' }}" placeholder="44000">
            </div>

            <div class="form-group">
                <label class="form-label">Ville</label>
                <input type="text" name="ville" class="form-control" value="{{ app.user.ville ?? '' }}" placeholder="Nantes">
            </div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Informations professionnelles</h2>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">SIRET</label>
                <input type="text" name="siret" class="form-control" value="{{ app.user.siret ?? '' }}" placeholder="123 456 789 00012">
            </div>

            <div class="form-group">
                <label class="form-label">Type d'activit√©</label>
                <input type="text" name="typeActivite" class="form-control" value="{{ app.user.typeActivite ?? '' }}" placeholder="Commerce, restauration...">
            </div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">S√©curit√©</h2>

        <div class="form-group">
            <label class="form-label">Nouveau mot de passe</label>
            <input type="password" name="nouveau_mot_de_passe" class="form-control" placeholder="Laissez vide pour ne pas changer">
            <small class="form-text">Minimum 8 caract√®res</small>
        </div>

        <div class="form-group">
            <label class="form-label">Confirmer le mot de passe</label>
            <input type="password" name="confirmer_mot_de_passe" class="form-control" placeholder="Confirmez le nouveau mot de passe">
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn-primary">
            Enregistrer les modifications
        </button>
        <a href="{{ path('locataire_dashboard') }}" class="btn-secondary">
            Annuler
        </a>
    </div>

</form>

<!-- Formulaire cach√© pour supprimer la photo -->
<form id="deletePhotoForm" method="post" action="{{ path('locataire_profil_delete_photo') }}" style="display: none;">
    <input type="hidden" name="_token" value="{{ csrf_token('delete_photo') }}">
</form>

<style>
/* Styles pour la section photo de profil */
.profile-photo-section {
    display: flex;
    align-items: center;
    gap: 24px;
}

.profile-photo-preview {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    border: 3px solid #e5e5e5;
}

.profile-photo-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-photo-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a1a, #333);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 600;
}

.profile-photo-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.btn-upload {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-delete-photo {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-delete-photo:hover {
    background: #dc3545;
    color: white;
}

.photo-hint {
    font-size: 13px;
    color: #6b6b6b;
    margin: 0;
}

@media (max-width: 768px) {
    .profile-photo-section {
        flex-direction: column;
        text-align: center;
    }

    .profile-photo-actions {
        align-items: center;
    }
}
</style>

<script>
function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // V√©rifier la taille
        if (file.size > 5 * 1024 * 1024) {
            alert('L\'image ne doit pas d√©passer 5 Mo.');
            input.value = '';
            return;
        }

        // V√©rifier le type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Le fichier doit √™tre une image (JPG, PNG, GIF ou WebP).');
            input.value = '';
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            const preview = document.getElementById('photoPreview');
            const placeholder = document.getElementById('photoPlaceholder');

            preview.src = e.target.result;
            preview.style.display = 'block';
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        };

        reader.readAsDataURL(file);
    }
}

function confirmDeletePhoto() {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer votre photo de profil ?')) {
        document.getElementById('deletePhotoForm').submit();
    }
}
</script>

{% endblock %}
